{
  "ruleChain": {
    "additionalInfo": {
      "description": ""
    },
    "name": "Trigger TEP Attestation Report",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null,
    "externalId": null
  },
  "metadata": {
    "firstNodeIndex": 2,
    "nodes": [
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 899,
          "layoutY": 154
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Create POST msg body",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var params = JSON.parse(msg.params);\nmetadata.hvs_endpoint = params.hvs_endpoint;\nmetadata.tcaas_endpoint = params.tcaas_endpoint;\nmetadata.tcaas_acc_id = params.tcaas_acc_id;\nmetadata.host_name = params.hostname;\nmetadata.token = \"eyJhbGciOiJSUzM4NCIsImtpZCI6IjExYmVkMzk2ZTAzZjExNWQxYTA4N2M5YThiYjY3N2NiY2FiNzQ4MDUiLCJ0eXAiOiJKV1QifQ.eyJyb2xlcyI6W3sic2VydmljZSI6IkhWUyIsIm5hbWUiOiJBZG1pbmlzdHJhdG9yIn1dLCJwZXJtaXNzaW9ucyI6W3sic2VydmljZSI6IkhWUyIsInJ1bGVzIjpbIio6KjoqIl19XSwiZXhwIjoxNzAwNTc1NjUzLCJpYXQiOjE2OTMzNzU2MjMsImlzcyI6IkFBUyBKV1QgSXNzdWVyIiwibmJmIjoxNjkzMzc1NjIzLCJzdWIiOiJnbG9iYWxBZG1pblVzZXJuYW1lIn0.a1Lkk0vAZv8ZobRjuxKnOGG_l0aT5na_Sg6bnDctSW530qgFa6iHhNMyNeeLYmuRQcmGfW5nMdeQS2jZd5OVdyhERlVTNWgClH0v9zb-nbOx0T7Z0AWFHlZa5rsbkQX2OMiWYxfuJxyLrpD17XsEtCU_vHIT4GfU89QJw_V17iCDckw1wARC487k6f8t5hMjxSjqM9m7stekBUXdQ4zGVUzRwVOkWJfaRxObNIEl-qWaqt5MMVASHcHXkiRTQjNy7HnSBKd78XqL9KoGDw3sqReMqvW6QPEp-Hs7X0fmgCKwqMnZQ5Wv22vUymxn7V7eFDKzhf8ae1AT5bJs2tDRD0-XbHs5fV-N7RlZGfqs52ORfguTVVv_NQxAzr2BIfuov78XKq_MX2c8x17QGdZCcj5syYRVXs9ml6CMTX4Sizh8_IapoBNRM6yw9BQRPCo01j06VlCD8fugyQDPYfuxECtZIglVVmIBxmiS0PT_JH6Nx-gLP1ns3BLB4KkPfICW\";\n\n// if the user doesn't provide information, use the current values from dashboard.\nif (!metadata.hvs_endpoint){\n    metadata.hvs_endpoint = metadata.cs_hvs_endpoint;\n}\n\nif (!metadata.tcaas_endpoint){\n    metadata.tcaas_endpoint = metadata.cs_tcaas_endpoint;\n}\n\nif (!metadata.tcaas_acc_id){\n    metadata.tcaas_acc_id = metadata.cs_tcaas_acc_id;\n}\n\nif (!metadata.host_name){\n    metadata.host_name = metadata.cs_tep_hostname;\n}\n\nvar message = {\n  host_name: metadata.host_name\n};\n\n\nreturn {msg: message, metadata: metadata, msgType: msgType};",
          "tbelScript": null
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 600,
          "layoutY": 151
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Check if trigger attestation request",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "return msg.method == \"triggerreport\";",
          "tbelScript": null
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 315,
          "layoutY": 150
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Check if INB device",
        "debugMode": true,
        "configuration": {
          "jsScript": "return metadata.deviceType === \"INB\";"
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1210,
          "layoutY": 154
        },
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Generate Attestation Report",
        "debugMode": true,
        "configuration": {
          "restEndpointUrlPattern": "${hvs_endpoint}/hvs/v2/reports",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": false,
          "ignoreRequestBody": false,
          "enableProxy": false,
          "useSystemProxyProperties": true,
          "proxyScheme": "https",
          "proxyHost": "http://proxy-dmz.intel.com",
          "proxyPort": 912,
          "proxyUser": null,
          "proxyPassword": null,
          "readTimeoutMs": 20000,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Authorization": "Bearer ${token}",
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          "useRedisQueueForMsgPersistence": false,
          "trimQueue": false,
          "maxQueueSize": 0,
          "credentials": {
            "type": "anonymous"
          }
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1838,
          "layoutY": 155
        },
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Send Report to TCaaS",
        "debugMode": true,
        "configuration": {
          "restEndpointUrlPattern": "${tcaas_endpoint}/hosts/${tcaas_acc_id}/assertions/tep",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": false,
          "ignoreRequestBody": false,
          "enableProxy": false,
          "useSystemProxyProperties": true,
          "proxyScheme": "https",
          "proxyHost": "http://proxy-dmz.intel.com",
          "proxyPort": 912,
          "proxyUser": null,
          "proxyPassword": null,
          "readTimeoutMs": 20000,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Authorization": "Bearer ${token}",
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          "useRedisQueueForMsgPersistence": false,
          "trimQueue": false,
          "maxQueueSize": 0,
          "credentials": {
            "type": "anonymous"
          }
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 2155,
          "layoutY": 314
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Create failure msg",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var body = {\r\n    \"event\": {\r\n        \"status\": 400,\r\n        \"logs\": metadata.error\r\n    }\r\n};\r\n\r\nmsgType = \"POST_TELEMETRY_REQUEST\";\r\nreturn { msg: body, metadata: metadata, msgType: msgType }",
          "tbelScript": null
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 2157,
          "layoutY": 156
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Create success msg",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var body = {\r\n    \"event\": {\r\n        \"Node overall Trust status\": metadata.overall,\r\n        \"Verifier\": \"Trigger Attestation Report complete.\",\r\n        \"TCaaS\": \"Assertion succuessfully reported.\"\r\n    }\r\n};\r\n\r\nmsgType = \"POST_TELEMETRY_REQUEST\";\r\nreturn { msg: body, metadata: metadata, msgType: msgType }",
          "tbelScript": null
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 2475,
          "layoutY": 160
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "Save logs",
        "debugMode": true,
        "configuration": {
          "defaultTTL": 0,
          "skipLatestPersistence": false,
          "useServerTs": false
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1534,
          "layoutY": 154
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Store overall result",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "metadata.overall = msg.trust_information.OVERALL;\r\n\r\nreturn { msg: msg, metadata: metadata, msgType: msgType }",
          "tbelScript": null
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 742,
          "layoutY": 293
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "Read current info from dashboard",
        "debugMode": true,
        "configuration": {
          "tellFailureIfAbsent": true,
          "fetchToData": false,
          "clientAttributeNames": [
            "hvs_endpoint",
            "tcaas_endpoint",
            "tcaas_acc_id",
            "tep_hostname"
          ],
          "sharedAttributeNames": [],
          "serverAttributeNames": [],
          "latestTsKeyNames": [],
          "getLatestValueWithTs": false
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 2681,
          "layoutY": 517
        },
        "type": "org.thingsboard.rule.engine.flow.TbRuleChainInputNode",
        "name": "Call refresh rule chain",
        "debugMode": false,
        "configuration": {
          "ruleChainId": "c75e1ac0-c3ba-11ed-b991-078ca01c7ec8"
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 2377,
          "layoutY": 523
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Create refresh request",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var body = {\r\n    \"method\": \"querypodstats\",\r\n    \"params\": \"{}\",\r\n    \"additionalInfo\": null\r\n};\r\n\r\nmsgType = \"POST_TELEMETRY_REQUEST\";\r\nreturn { msg: body, metadata: metadata, msgType: msgType }",
          "tbelScript": null
        },
        "externalId": null
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 3,
        "type": "Success"
      },
      {
        "fromIndex": 1,
        "toIndex": 9,
        "type": "True"
      },
      {
        "fromIndex": 2,
        "toIndex": 1,
        "type": "True"
      },
      {
        "fromIndex": 3,
        "toIndex": 5,
        "type": "Failure"
      },
      {
        "fromIndex": 3,
        "toIndex": 8,
        "type": "Success"
      },
      {
        "fromIndex": 4,
        "toIndex": 5,
        "type": "Failure"
      },
      {
        "fromIndex": 4,
        "toIndex": 6,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 6,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 11,
        "type": "Success"
      },
      {
        "fromIndex": 8,
        "toIndex": 4,
        "type": "Success"
      },
      {
        "fromIndex": 9,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 11,
        "toIndex": 10,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}