{
  "ruleChain": {
    "additionalInfo": {
      "description": ""
    },
    "name": "Register TCaaS",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null,
    "externalId": null
  },
  "metadata": {
    "firstNodeIndex": 3,
    "nodes": [
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 595,
          "layoutY": 145
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Registration Body",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var params = JSON.parse(msg.params);\nmetadata.tcaas_endpoint = params[\"tcaas_endpoint\"];\n\nvar body = {\n  \"info\": {\n    \"name\": \"node-01\",\n    \"details\": \"Cluster-01\"\n  },\n  \"policy\": {\n    \"assertion_type\": [\n      \"TEP\"\n    ],\n    \"evaluation\": {\n        \"level\": 1,\n        \"data\": \"None\"\n    }\n  }\n};\n\nreturn {msg: body, metadata: metadata, msgType: msgType};",
          "tbelScript": null
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 730,
          "layoutY": 277
        },
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Register with TCaaS",
        "debugMode": true,
        "configuration": {
          "restEndpointUrlPattern": "${tcaas_endpoint}/hosts/create",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": false,
          "ignoreRequestBody": false,
          "enableProxy": false,
          "useSystemProxyProperties": true,
          "proxyScheme": "https",
          "proxyHost": "http://proxy-dmz.intel.com",
          "proxyPort": 912,
          "proxyUser": null,
          "proxyPassword": null,
          "readTimeoutMs": 20000,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "Host": "tcaas-service.com"
          },
          "useRedisQueueForMsgPersistence": false,
          "trimQueue": false,
          "maxQueueSize": 0,
          "credentials": {
            "type": "anonymous"
          }
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 348,
          "layoutY": 276
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Check if register host request",
        "debugMode": false,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "return msg.method == \"registerhosttcaas\";",
          "tbelScript": null
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 352,
          "layoutY": 148
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Check if INB device",
        "debugMode": false,
        "configuration": {
          "jsScript": "return metadata.deviceType === \"INB\";"
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1104,
          "layoutY": 279
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "Save TCaaS account id",
        "debugMode": true,
        "configuration": {
          "scope": "CLIENT_SCOPE",
          "notifyDevice": false,
          "sendAttributesUpdatedNotification": false
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 894,
          "layoutY": 145
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Update Account ID and TCaaS endpoint Attribute",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "if (!msg.attributes) {\r\n  msg.attributes = {\r\n    tcaas_acc_id: msg.node_id,\r\n    tcaas_endpoint: metadata.tcaas_endpoint\r\n  }\r\n};\r\nmsgType = \"POST_ATTRIBUTES_REQUEST\";\r\nreturn { msg: msg.attributes, metadata: metadata, msgType: msgType }",
          "tbelScript": null
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1426,
          "layoutY": 269
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "Save logs",
        "debugMode": false,
        "configuration": {
          "defaultTTL": 0,
          "skipLatestPersistence": false,
          "useServerTs": false
        },
        "externalId": null
      },
      {
        "additionalInfo": {
          "description": "",
          "layoutX": 1258,
          "layoutY": 152
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Add logs body",
        "debugMode": true,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var body = {\r\n    \"event\": \"Register with TCaaS complete. TCaaS ID = \" + msg.tcaas_acc_id\r\n};\r\n\r\nmsgType = \"POST_TELEMETRY_REQUEST\";\r\nreturn { msg: body, metadata: metadata, msgType: msgType }",
          "tbelScript": null
        },
        "externalId": null
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 1,
        "type": "Success"
      },
      {
        "fromIndex": 1,
        "toIndex": 5,
        "type": "Success"
      },
      {
        "fromIndex": 2,
        "toIndex": 0,
        "type": "True"
      },
      {
        "fromIndex": 3,
        "toIndex": 2,
        "type": "True"
      },
      {
        "fromIndex": 4,
        "toIndex": 7,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 4,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 6,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}